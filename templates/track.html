{% extends "base.html" %}

{% block title %}Трек · {{ track.name }} · ANTIGAZ{% endblock %}

{% block content %}
<div class="page-content" id="track-page-root">
    <section class="top-panel">
        <div class="top-panel-main">
            <div class="top-panel-label">Карточка трека</div>
            <p class="top-panel-subtext">
                Минималистичная сводка по оценкам стримеров и рецензиям пользователей.
            </p>
            <a href="{{ url_for('top_tracks') }}" class="btn-ghost track-back-btn">
                <span class="track-back-icon">←</span>
                <span>Вернуться к топу</span>
            </a>
        </div>
    </section>

    <section class="top-list-section">
        <div class="top-table-card track-hero-card">
            <div class="track-hero-header">
                <div>
                    <h1 class="track-title">{{ track.name }}</h1>
                    <p class="track-meta">
                        Добавлен: {{ track.created_at.strftime('%d.%m.%Y %H:%M') if track.created_at else 'Дата неизвестна' }}
                    </p>
                </div>
                <div class="track-hero-actions">
                    {# оценки пользователей теперь привязаны к рецензиям ниже #}
                    <div class="track-share-wrapper">
                        <button type="button"
                                class="btn-ghost track-share-trigger"
                                id="track-share-btn"
                                aria-haspopup="true"
                                aria-expanded="false"
                                data-share-url="{{ url_for('track_page', track_id=track.id, _external=True) }}">
                            <span class="track-share-icon">⤴</span>
                            <span class="track-share-label">Поделиться</span>
                        </button>
                        <div class="track-share-popover" id="track-share-popover">
                            <div class="track-share-popover-inner">
                                <div class="track-share-popover-title">Поделиться треком</div>
                                <div class="track-share-popover-grid">
                                    <button type="button" class="track-share-option" data-share-kind="tg">
                                        <span class="track-share-option-main">Telegram</span>
                                        <span class="track-share-option-sub">Открыть окно шаринга</span>
                                    </button>
                                    <button type="button" class="track-share-option" data-share-kind="vk">
                                        <span class="track-share-option-main">VK</span>
                                        <span class="track-share-option-sub">Поделиться во VK</span>
                                    </button>
                                    <button type="button" class="track-share-option" data-share-kind="copy">
                                        <span class="track-share-option-main">Скопировать ссылку</span>
                                        <span class="track-share-option-sub">В буфер обмена</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% if audio_url %}
                <div class="track-audio-block">
                    <div class="track-audio-label">Прослушивание</div>
                    {# Кастомный плеер в стиле панели оценки (без SocketIO-синхронизации) #}
                    {% set audio_src = audio_url %}
                    {% set player_id = "track-player-" ~ (track.id if track is defined else "single") %}
                    {% set player_title = player_title %}
                    {% set player_subtitle = player_subtitle %}
                    {% include "partials/yplayer_embed.html" %}
                </div>
            {% endif %}

            <div class="track-summary-grid">
                <div class="track-summary-main">
                    <div class="track-overall-block">
                        <div class="track-overall-label">Итоговый средний балл</div>
                        <div class="track-overall-value score-chip" id="track-page-overall">
                            {% if overall_avg is not none %}
                                {{ '%.2f'|format(overall_avg) }}
                            {% else %}
                                ?
                            {% endif %}
                        </div>
                    </div>

                    <div class="track-section">
                        <h2 class="track-section-title">Параметры (стримеры)</h2>
                        <table class="stats-table">
                            <thead>
                                <tr>
                                    <th>Параметр</th>
                                    <th>Средний балл</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if criteria_stats %}
                                    {% for c in criteria_stats %}
                                        <tr>
                                            <td data-label="Параметр">
                                                {% for key, label in CRITERIA %}
                                                    {% if key == c.key %}
                                                        {{ label }}
                                                    {% endif %}
                                                {% endfor %}
                                            </td>
                                            <td class="track-score-cell" data-label="Средний балл">
                                                {% if c.avg is not none %}
                                                    <span class="score-chip">{{ '%.2f'|format(c.avg) }}</span>
                                                {% else %}
                                                    ?
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="2"><em>Пока нет оценок стримеров.</em></td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>

                    <div class="track-section">
                        <h2 class="track-section-title">Рецензии пользователей</h2>
                        <div class="track-viewer-overall" style="justify-content:flex-start; gap:12px; flex-wrap:wrap;">
                            <span class="track-viewer-label">Средний балл:</span>
                            <span class="score-chip">
                                {% if review_overall is not none %}
                                    {{ '%.2f'|format(review_overall) }}
                                {% else %}
                                    ?
                                {% endif %}
                            </span>
                            <span class="track-viewer-label" style="margin-left:6px;">Рецензий:</span>
                            <span class="score-chip">{{ review_count }}</span>
                        </div>
                        <p class="field-hint" style="margin-top:10px;">
                            Одна рецензия от одного пользователя. Оценка привязана к тексту.
                        </p>
                    </div>
                </div>

                <aside class="track-summary-side">
                    <div class="track-section">
                        <h2 class="track-section-title">Оценщики</h2>
                        <table class="stats-table">
                            <thead>
                                <tr>
                                    <th>Оценщик</th>
                                    <th>Средний балл</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if raters_stats %}
                                    {% for r in raters_stats %}
                                        <tr>
                                            <td data-label="Оценщик">{{ r.name }}</td>
                                            <td class="track-score-cell" data-label="Средний балл">
                                                {% if r.avg is not none %}
                                                    <span class="score-chip">{{ '%.2f'|format(r.avg) }}</span>
                                                {% else %}
                                                    ?
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="2"><em>Пока нет оценок стримеров для этого трека.</em></td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </aside>
            </div>
        </div>
    </section>

    <section class="top-list-section" id="reviews">
    <div class="top-table-card reviews-card">
        <div class="reviews-header">
            <div class="reviews-header-main">
                <h2 class="home-section-title">Рецензии</h2>
                <p class="home-section-subtitle">
                    1 пользователь = 1 рецензия на трек. Оценка всегда идёт вместе с текстом.
                </p>
            </div>
            <div class="reviews-header-stats">
                <div class="reviews-stat">
                    <span class="reviews-stat-label">Средний балл</span>
                    <span class="score-chip">
                        {% if review_overall is not none %}
                            {{ '%.2f'|format(review_overall) }}
                        {% else %}
                            ?
                        {% endif %}
                    </span>
                </div>
                <div class="reviews-stat">
                    <span class="reviews-stat-label">Рецензий</span>
                    <span class="score-chip">{{ review_count }}</span>
                </div>
            </div>
        </div>

        {% if not current_user %}
            <div class="reviews-empty-state">
                <p class="field-hint">
                    Чтобы оставить рецензию, нужно <a href="{{ url_for('login') }}" data-turbo="false">войти</a>
                    или <a href="{{ url_for('register') }}" data-turbo="false">зарегистрироваться</a>.
                </p>
            </div>
        {% elif not current_user.is_email_verified() %}
            <div class="reviews-empty-state">
                <p class="field-hint">
                    Подтверди email, чтобы оставлять рецензии.
                </p>
                <div class="admin-actions" style="margin-top:10px;">
                    <a href="{{ url_for('settings_profile') }}" class="btn-ghost" data-turbo="false">Перейти в профиль</a>
                    <form method="post" action="{{ url_for('settings_email_resend') }}" style="display:inline-block;" data-turbo="false">
                        <button type="submit" class="btn-primary">Отправить письмо ещё раз</button>
                    </form>
                </div>
            </div>
        {% else %}
            <form method="post"
                  action="{{ url_for('submit_review', track_id=track.id) }}"
                  class="track-comment-form review-form">
                <div class="review-form-top">
                    <div class="review-form-title">
                        <div class="review-form-title-main">Твоя рецензия</div>
                        <div class="review-form-title-sub">
                            Поставь оценки по критериям — общий балл посчитается автоматически.
                        </div>
                    </div>

                    <div class="review-form-overall">
                        <div class="review-form-overall-label">Твой общий балл</div>
                        <div class="modal-overall-value score-chip" id="review-self-overall">0.00</div>
                    </div>
                </div>

                <div class="track-comment-grid review-form-grid">
                    <div class="review-sliders">
                        {% for key, label in CRITERIA %}
                            <div class="slider-row viewer-slider-row review-slider-row">
                                <div class="slider-label">{{ label }}</div>
                                <div class="slider-control">
                                    <input type="range"
                                           min="0" max="10" step="1"
                                           name="score_{{ key }}"
                                           value="{{ (my_review_score_map[key] if my_review_score_map is defined else 0) }}"
                                           class="viewer-slider review-criterion-slider"
                                           data-criterion="{{ key }}">
                                    <div class="slider-value score-chip" data-criterion-value="{{ key }}">{{ (my_review_score_map[key] if my_review_score_map is defined else 0) }}</div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <label class="auth-field review-text-field">
                        <span>Текст</span>
                        <textarea name="text"
                                  rows="5"
                                  maxlength="4000"
                                  required
                                  placeholder="Коротко: что понравилось/не понравилось и почему такая оценка…">{% if my_review %}{{ my_review.text|e }}{% endif %}</textarea>
                    </label>
                </div>

                <div class="admin-actions review-form-actions">
                    <button type="submit" class="btn-primary">
                        {% if my_review %}Сохранить изменения{% else %}Опубликовать рецензию{% endif %}
                    </button>
                </div>
            </form>
        {% endif %}

        <div class="track-comments-list reviews-list">
            {% if reviews %}
                {% for r in reviews %}
                    <article class="track-comment-item track-review-card">
                        <div class="track-comment-header review-card-header">
                            <div class="track-comment-header-main">
                                <span class="track-comment-author">@{{ r.user.username }}</span>
                                <span class="track-comment-date">
                                    {{ r.created_at.strftime('%d.%m.%Y %H:%M') if r.created_at else '' }}
                                </span>
                            </div>
                            <span class="score-chip review-card-score">{{ '%.2f'|format(r.overall) }}</span>
                        </div>

                        <p class="track-comment-text review-preview">
                            {{ r.text|truncate(220, True, '…') }}
                        </p>

                        <details class="track-review-details review-details">
                            <summary class="track-review-summary review-details-summary">Открыть полностью</summary>

                            <div class="review-details-body">
                                <div class="review-criteria-grid">
                                    {% for key, label in CRITERIA %}
                                        {% set ns = namespace(v=0) %}
                                        {% if r.scores %}
                                            {% for s in r.scores %}
                                                {% if s.criterion_key == key %}
                                                    {% set ns.v = s.score %}
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                        <div class="review-criteria-row">
                                            <span class="review-criteria-label">{{ label }}</span>
                                            <span class="score-chip review-criteria-score">{{ ns.v }}</span>
                                        </div>
                                    {% endfor %}
                                </div>

                                <p class="track-comment-text review-fulltext">{{ r.text }}</p>
                            </div>
                        </details>
                    </article>
                {% endfor %}
            {% else %}
                <div class="reviews-empty-state">
                    <p class="field-hint">Пока нет ни одной рецензии. Будь первым!</p>
                </div>
            {% endif %}
        </div>
    </div>
</section>
</div>


{% endblock %}

{% block scripts %}
    {{ super() }}
<script>
// Turbo-safe init for Track page actions
(function () {
  function initTrackPage() {
    var overallEl = document.getElementById("track-page-overall");
    if (overallEl) {
        var val = parseFloat(overallEl.textContent.replace(",", "."));
        if (!isNaN(val) && typeof window.applyHeatToChip === "function") {
            window.applyHeatToChip(overallEl, val);
        }
    }

    // Оценки в форме рецензии (по критериям)
    var overallChip = document.getElementById("review-self-overall");
    var sliders = Array.prototype.slice.call(document.querySelectorAll(".review-criterion-slider"));
    if (sliders.length && overallChip) {
        function computeOverall() {
            var sum = 0;
            sliders.forEach(function (sl) {
                var v = parseInt(sl.value || "0", 10);
                if (!isNaN(v)) sum += v;
            });
            var overall = sliders.length ? (sum / sliders.length) : 0;
            overallChip.textContent = overall.toFixed(2);
            if (typeof window.applyHeatToChip === "function") {
                window.applyHeatToChip(overallChip, overall);
            }
        }
        sliders.forEach(function (sl) {
            if (sl.dataset.bound) return;
            sl.dataset.bound = "1";
            var crit = sl.getAttribute("data-criterion");
            var chip = document.querySelector('[data-criterion-value="' + crit + '"]');
            var sync = function () {
                if (chip) chip.textContent = sl.value;
                computeOverall();
            };
            sl.addEventListener("input", sync);
        });
        computeOverall();
    }

    // Поповер шаринга
    var shareBtn = document.getElementById("track-share-btn");
    var popover = document.getElementById("track-share-popover");
    if (shareBtn && popover) {
        var shareUrl = shareBtn.getAttribute("data-share-url") || window.location.href;
        function togglePopover() {
            var isOpen = popover.classList.toggle("is-open");
            shareBtn.setAttribute("aria-expanded", isOpen ? "true" : "false");
        }
        if (!shareBtn.dataset.bound) {
            shareBtn.dataset.bound = "1";
            shareBtn.addEventListener("click", function (e) {
                e.stopPropagation();
                togglePopover();
            });
        }

        // One global document click handler (Turbo keeps the document)
        if (!window.__TRACK_SHARE_DOC_BOUND__) {
            window.__TRACK_SHARE_DOC_BOUND__ = true;
            document.addEventListener("click", function () {
                var p = document.getElementById("track-share-popover");
                var b = document.getElementById("track-share-btn");
                if (p) p.classList.remove("is-open");
                if (b) b.setAttribute("aria-expanded", "false");
            });
        }

        if (!popover.dataset.bound) {
            popover.dataset.bound = "1";
            popover.addEventListener("click", function (e) {
                e.stopPropagation();
            });
        }

        Array.prototype.slice.call(popover.querySelectorAll(".track-share-option")).forEach(function (btn) {
            if (btn.dataset.bound) return;
            btn.dataset.bound = "1";
            btn.addEventListener("click", function () {
                var kind = btn.getAttribute("data-share-kind");
                var urlEnc = encodeURIComponent(shareUrl);
                if (kind === "tg") {
                    var tgUrl = "https://t.me/share/url?url=" + urlEnc;
                    window.open(tgUrl, "_blank");
                } else if (kind === "vk") {
                    var vkUrl = "https://vk.com/share.php?url=" + urlEnc;
                    window.open(vkUrl, "_blank");
                } else {
                    // Discord и копирование — просто копируем ссылку
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(shareUrl);
                    } else {
                        prompt("Скопируй ссылку на трек:", shareUrl);
                    }
                }
                popover.classList.remove("is-open");
                shareBtn.setAttribute("aria-expanded", "false");
            });
        });
    }
  }

  // Run once on initial load and on Turbo navigations.
  document.addEventListener("turbo:load", initTrackPage);
})();
</script>
{% endblock %}
