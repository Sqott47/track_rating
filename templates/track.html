{% extends "base.html" %}

{% block title %}–¢—Ä–µ–∫ ¬∑ {{ track.name }} ¬∑ ANTIGAZ{% endblock %}

{% block content %}
<div class="page-content" id="track-page-root">
    <section class="top-panel">
        <div class="top-panel-main">
            <div class="top-panel-label">–ö–∞—Ä—Ç–æ—á–∫–∞ —Ç—Ä–µ–∫–∞</div>
            <p class="top-panel-subtext">
                –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è —Å–≤–æ–¥–∫–∞ –ø–æ –æ—Ü–µ–Ω–∫–∞–º —Å—Ç—Ä–∏–º–µ—Ä–æ–≤ –∏ —Ä–µ—Ü–µ–Ω–∑–∏—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
            </p>
            <a href="{{ url_for('top_tracks') }}" class="btn-ghost track-back-btn">
                <span class="track-back-icon">‚Üê</span>
                <span>–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç–æ–ø—É</span>
            </a>
        </div>
    </section>

    <section class="top-list-section">
        <div class="top-table-card track-hero-card">
            <div class="track-hero-header">
                <div>
                    <h1 class="track-title">{{ track.name }}</h1>
                    {% if award_wins and award_wins|length %}
                        {% set b = award_wins[0] %}
                        <div style="margin-top:8px;">
                            <span class="award-tag award-tag--win">{{ b.emoji }} –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: {{ b.title }}</span>
                        </div>
                    {% elif award_noms and award_noms|length %}
                        {% set b = award_noms[0] %}
                        <div style="margin-top:8px;">
                            <span class="award-tag">{{ b.emoji }} –ù–æ–º–∏–Ω–∞–Ω—Ç: {{ b.title }}</span>
                        </div>
                    {% endif %}
                    <p class="track-meta">
                        –î–æ–±–∞–≤–ª–µ–Ω: {{ track.created_at.strftime('%d.%m.%Y %H:%M') if track.created_at else '–î–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞' }}
                    </p>
                </div>
                <div class="track-hero-actions">
                    {% if is_admin and active_awards and active_awards|length %}
                        <details class="nominate-menu" style="margin-right:10px;">
                            <summary class="btn-ghost" style="padding:10px 12px;">üèÖ –ù–æ–º–∏–Ω–∏—Ä–æ–≤–∞—Ç—å</summary>
                            <div class="nominate-menu__panel">
                                {% for a in active_awards %}
                                    <form method="post" action="{{ url_for('award_nominate', award_id=a.id, track_id=track.id) }}">
                                        <button type="submit" class="nominate-menu__item">–í ¬´{{ a.title }}¬ª</button>
                                    </form>
                                {% endfor %}
                            </div>
                        </details>
                    {% endif %}
                    {# –æ—Ü–µ–Ω–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —Ä–µ—Ü–µ–Ω–∑–∏—è–º –Ω–∏–∂–µ #}
                    <div class="track-share-wrapper">
                        <button type="button"
                                class="btn-ghost track-share-trigger"
                                id="track-share-btn"
                                aria-haspopup="true"
                                aria-expanded="false"
                                data-share-url="{{ url_for('track_page', track_id=track.id, _external=True) }}">
                            <span class="track-share-icon">‚§¥</span>
                            <span class="track-share-label">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span>
                        </button>
                        <div class="track-share-popover" id="track-share-popover">
                            <div class="track-share-popover-inner">
                                <div class="track-share-popover-title">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ç—Ä–µ–∫–æ–º</div>
                                <div class="track-share-popover-grid">
                                    <button type="button" class="track-share-option" data-share-kind="tg">
                                        <span class="track-share-option-main">Telegram</span>
                                        <span class="track-share-option-sub">–û—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ —à–∞—Ä–∏–Ω–≥–∞</span>
                                    </button>
                                    <button type="button" class="track-share-option" data-share-kind="vk">
                                        <span class="track-share-option-main">VK</span>
                                        <span class="track-share-option-sub">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤–æ VK</span>
                                    </button>
                                    <button type="button" class="track-share-option" data-share-kind="copy">
                                        <span class="track-share-option-main">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</span>
                                        <span class="track-share-option-sub">–í –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% if audio_url %}
                <div class="track-audio-block">
                    <div class="track-audio-label">–ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ</div>
                    {# –ö–∞—Å—Ç–æ–º–Ω—ã–π –ø–ª–µ–µ—Ä –≤ —Å—Ç–∏–ª–µ –ø–∞–Ω–µ–ª–∏ –æ—Ü–µ–Ω–∫–∏ (–±–µ–∑ SocketIO-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏) #}
                    {% set audio_src = audio_url %}
                    {% set player_id = "track-player-" ~ (track.id if track is defined else "single") %}
                    {% set player_title = player_title %}
                    {% set player_subtitle = player_subtitle %}
                    {% include "partials/yplayer_embed.html" %}
                </div>
            {% endif %}

            <div class="track-summary-grid">
                <div class="track-summary-main">
                    <div class="track-overall-block">
                        <div class="track-overall-label">–ò—Ç–æ–≥–æ–≤—ã–π —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</div>
                        <div class="track-overall-value score-chip" id="track-page-overall">
                            {% if overall_avg is not none %}
                                {{ '%.2f'|format(overall_avg) }}
                            {% else %}
                                ?
                            {% endif %}
                        </div>
                    </div>

                    <div class="track-section">
                        <h2 class="track-section-title">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã (—Å—Ç—Ä–∏–º–µ—Ä—ã)</h2>
                        <table class="stats-table">
                            <thead>
                                <tr>
                                    <th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th>
                                    <th>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if criteria_stats %}
                                    {% for c in criteria_stats %}
                                        <tr>
                                            <td data-label="–ü–∞—Ä–∞–º–µ—Ç—Ä">
                                                {% for key, label in CRITERIA %}
                                                    {% if key == c.key %}
                                                        {{ label }}
                                                    {% endif %}
                                                {% endfor %}
                                            </td>
                                            <td class="track-score-cell" data-label="–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª">
                                                {% if c.avg is not none %}
                                                    <span class="score-chip">{{ '%.2f'|format(c.avg) }}</span>
                                                {% else %}
                                                    ?
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="2"><em>–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ü–µ–Ω–æ–∫ —Å—Ç—Ä–∏–º–µ—Ä–æ–≤.</em></td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>

                    <div class="track-section">
                        <h2 class="track-section-title">–†–µ—Ü–µ–Ω–∑–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
                        <div class="track-viewer-overall" style="justify-content:flex-start; gap:12px; flex-wrap:wrap;">
                            <span class="track-viewer-label">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª:</span>
                            <span class="score-chip">
                                {% if review_overall is not none %}
                                    {{ '%.2f'|format(review_overall) }}
                                {% else %}
                                    ?
                                {% endif %}
                            </span>
                            <span class="track-viewer-label" style="margin-left:6px;">–†–µ—Ü–µ–Ω–∑–∏–π:</span>
                            <span class="score-chip">{{ review_count }}</span>
                        </div>
                        <p class="field-hint" style="margin-top:10px;">
                            –û–¥–Ω–∞ —Ä–µ—Ü–µ–Ω–∑–∏—è –æ—Ç –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –û—Ü–µ–Ω–∫–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ —Ç–µ–∫—Å—Ç—É.
                        </p>
                    </div>
                </div>

                <aside class="track-summary-side">
                    <div class="track-section">
                        <h2 class="track-section-title">–û—Ü–µ–Ω—â–∏–∫–∏</h2>
                        <table class="stats-table">
                            <thead>
                                <tr>
                                    <th>–û—Ü–µ–Ω—â–∏–∫</th>
                                    <th>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if raters_stats %}
                                    {% for r in raters_stats %}
                                        <tr>
                                            <td data-label="–û—Ü–µ–Ω—â–∏–∫">{{ r.name }}</td>
                                            <td class="track-score-cell" data-label="–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª">
                                                {% if r.avg is not none %}
                                                    <span class="score-chip">{{ '%.2f'|format(r.avg) }}</span>
                                                {% else %}
                                                    ?
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="2"><em>–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ü–µ–Ω–æ–∫ —Å—Ç—Ä–∏–º–µ—Ä–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ —Ç—Ä–µ–∫–∞.</em></td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </aside>
            </div>
        </div>
    </section>

    <section class="top-list-section" id="reviews">
    <div class="top-table-card reviews-card">
        <div class="reviews-header">
            <div class="reviews-header-main">
                <h2 class="home-section-title">–†–µ—Ü–µ–Ω–∑–∏–∏</h2>
                <p class="home-section-subtitle">
                    1 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = 1 —Ä–µ—Ü–µ–Ω–∑–∏—è –Ω–∞ —Ç—Ä–µ–∫. –û—Ü–µ–Ω–∫–∞ –≤—Å–µ–≥–¥–∞ –∏–¥—ë—Ç –≤–º–µ—Å—Ç–µ —Å —Ç–µ–∫—Å—Ç–æ–º.
                </p>
            </div>
            <div class="reviews-header-stats">
                <div class="reviews-stat">
                    <span class="reviews-stat-label">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</span>
                    <span class="score-chip">
                        {% if review_overall is not none %}
                            {{ '%.2f'|format(review_overall) }}
                        {% else %}
                            ?
                        {% endif %}
                    </span>
                </div>
                <div class="reviews-stat">
                    <span class="reviews-stat-label">–†–µ—Ü–µ–Ω–∑–∏–π</span>
                    <span class="score-chip">{{ review_count }}</span>
                </div>
            </div>
        </div>

        {% if not current_user %}
            <div class="reviews-empty-state">
                <p class="field-hint">
                    –ß—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å —Ä–µ—Ü–µ–Ω–∑–∏—é, –Ω—É–∂–Ω–æ <a href="{{ url_for('login') }}" data-turbo="false">–≤–æ–π—Ç–∏</a>
                    –∏–ª–∏ <a href="{{ url_for('register') }}" data-turbo="false">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>.
                </p>
            </div>
        {% elif not current_user.is_email_verified() %}
            <div class="reviews-empty-state">
                <p class="field-hint">
                    –ü–æ–¥—Ç–≤–µ—Ä–¥–∏ email, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–ª—è—Ç—å —Ä–µ—Ü–µ–Ω–∑–∏–∏.
                </p>
                <div class="admin-actions" style="margin-top:10px;">
                    <a href="{{ url_for('settings_profile') }}" class="btn-ghost" data-turbo="false">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å</a>
                    <form method="post" action="{{ url_for('settings_email_resend') }}" style="display:inline-block;" data-turbo="false">
                        <button type="submit" class="btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ –µ—â—ë —Ä–∞–∑</button>
                    </form>
                </div>
            </div>
        {% else %}
            <form method="post"
                  action="{{ url_for('submit_review', track_id=track.id) }}"
                  class="track-comment-form review-form">
                <div class="review-form-top">
                    <div class="review-form-title">
                        <div class="review-form-title-main">–¢–≤–æ—è —Ä–µ—Ü–µ–Ω–∑–∏—è</div>
                        <div class="review-form-title-sub">
                            –ü–æ—Å—Ç–∞–≤—å –æ—Ü–µ–Ω–∫–∏ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º ‚Äî –æ–±—â–∏–π –±–∞–ª–ª –ø–æ—Å—á–∏—Ç–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
                        </div>
                    </div>

                    <div class="review-form-overall">
                        <div class="review-form-overall-label">–¢–≤–æ–π –æ–±—â–∏–π –±–∞–ª–ª</div>
                        <div class="modal-overall-value score-chip" id="review-self-overall">0.00</div>
                    </div>
                </div>

                <div class="track-comment-grid review-form-grid">
                    <div class="review-sliders">
                        {% for key, label in CRITERIA %}
                            <div class="slider-row viewer-slider-row review-slider-row">
                                <div class="slider-label">{{ label }}</div>
                                <div class="slider-control">
                                    <input type="range"
                                           min="0" max="10" step="1"
                                           name="score_{{ key }}"
                                           value="{{ (my_review_score_map[key] if my_review_score_map is defined else 0) }}"
                                           class="viewer-slider review-criterion-slider"
                                           data-criterion="{{ key }}">
                                    <div class="slider-value score-chip" data-criterion-value="{{ key }}">{{ (my_review_score_map[key] if my_review_score_map is defined else 0) }}</div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <label class="auth-field review-text-field">
                        <span>–¢–µ–∫—Å—Ç</span>
                        <textarea name="text"
                                  rows="5"
                                  maxlength="4000"
                                  required
                                  placeholder="–ö–æ—Ä–æ—Ç–∫–æ: —á—Ç–æ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å/–Ω–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å –∏ –ø–æ—á–µ–º—É —Ç–∞–∫–∞—è –æ—Ü–µ–Ω–∫–∞‚Ä¶">{% if my_review %}{{ my_review.text|e }}{% endif %}</textarea>
                    </label>
                </div>

                <div class="admin-actions review-form-actions">
                    <button type="submit" class="btn-primary">
                        {% if my_review %}–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è{% else %}–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Ä–µ—Ü–µ–Ω–∑–∏—é{% endif %}
                    </button>
                </div>
            </form>
        {% endif %}

        <div class="track-comments-list reviews-list">
            {% if reviews %}
                {% for r in reviews %}
                    <article class="track-comment-item track-review-card">
                        <div class="track-comment-header review-card-header">
                            <div class="track-comment-header-main">
                                <span class="track-comment-author">@{{ r.user.username }}</span>
                                <span class="track-comment-date">
                                    {{ r.created_at.strftime('%d.%m.%Y %H:%M') if r.created_at else '' }}
                                </span>
                            </div>
                            <span class="score-chip review-card-score">{{ '%.2f'|format(r.overall) }}</span>
                        </div>

                        <p class="track-comment-text review-preview">
                            {{ r.text|truncate(220, True, '‚Ä¶') }}
                        </p>

                        <details class="track-review-details review-details">
                            <summary class="track-review-summary review-details-summary">–û—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é</summary>

                            <div class="review-details-body">
                                <div class="review-criteria-grid">
                                    {% for key, label in CRITERIA %}
                                        {% set ns = namespace(v=0) %}
                                        {% if r.scores %}
                                            {% for s in r.scores %}
                                                {% if s.criterion_key == key %}
                                                    {% set ns.v = s.score %}
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                        <div class="review-criteria-row">
                                            <span class="review-criteria-label">{{ label }}</span>
                                            <span class="score-chip review-criteria-score">{{ ns.v }}</span>
                                        </div>
                                    {% endfor %}
                                </div>

                                <p class="track-comment-text review-fulltext">{{ r.text }}</p>
                            </div>
                        </details>
                    </article>
                {% endfor %}
            {% else %}
                <div class="reviews-empty-state">
                    <p class="field-hint">–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π —Ä–µ—Ü–µ–Ω–∑–∏–∏. –ë—É–¥—å –ø–µ—Ä–≤—ã–º!</p>
                </div>
            {% endif %}
        </div>
    </div>
</section>
</div>


{% endblock %}

{% block scripts %}
    {{ super() }}
<script>
// Turbo-safe init for Track page actions
(function () {
  function initTrackPage() {
    var overallEl = document.getElementById("track-page-overall");
    if (overallEl) {
        var val = parseFloat(overallEl.textContent.replace(",", "."));
        if (!isNaN(val) && typeof window.applyHeatToChip === "function") {
            window.applyHeatToChip(overallEl, val);
        }
    }

    // –û—Ü–µ–Ω–∫–∏ –≤ —Ñ–æ—Ä–º–µ —Ä–µ—Ü–µ–Ω–∑–∏–∏ (–ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º)
    var overallChip = document.getElementById("review-self-overall");
    var sliders = Array.prototype.slice.call(document.querySelectorAll(".review-criterion-slider"));
    if (sliders.length && overallChip) {
        function computeOverall() {
            var sum = 0;
            sliders.forEach(function (sl) {
                var v = parseInt(sl.value || "0", 10);
                if (!isNaN(v)) sum += v;
            });
            var overall = sliders.length ? (sum / sliders.length) : 0;
            overallChip.textContent = overall.toFixed(2);
            if (typeof window.applyHeatToChip === "function") {
                window.applyHeatToChip(overallChip, overall);
            }
        }
        sliders.forEach(function (sl) {
            if (sl.dataset.bound) return;
            sl.dataset.bound = "1";
            var crit = sl.getAttribute("data-criterion");
            var chip = document.querySelector('[data-criterion-value="' + crit + '"]');
            var sync = function () {
                if (chip) chip.textContent = sl.value;
                computeOverall();
            };
            sl.addEventListener("input", sync);
        });
        computeOverall();
    }

    // –ü–æ–ø–æ–≤–µ—Ä —à–∞—Ä–∏–Ω–≥–∞
    var shareBtn = document.getElementById("track-share-btn");
    var popover = document.getElementById("track-share-popover");
    if (shareBtn && popover) {
        var shareUrl = shareBtn.getAttribute("data-share-url") || window.location.href;
        function togglePopover() {
            var isOpen = popover.classList.toggle("is-open");
            shareBtn.setAttribute("aria-expanded", isOpen ? "true" : "false");
        }
        if (!shareBtn.dataset.bound) {
            shareBtn.dataset.bound = "1";
            shareBtn.addEventListener("click", function (e) {
                e.stopPropagation();
                togglePopover();
            });
        }

        // One global document click handler (Turbo keeps the document)
        if (!window.__TRACK_SHARE_DOC_BOUND__) {
            window.__TRACK_SHARE_DOC_BOUND__ = true;
            document.addEventListener("click", function () {
                var p = document.getElementById("track-share-popover");
                var b = document.getElementById("track-share-btn");
                if (p) p.classList.remove("is-open");
                if (b) b.setAttribute("aria-expanded", "false");
            });
        }

        if (!popover.dataset.bound) {
            popover.dataset.bound = "1";
            popover.addEventListener("click", function (e) {
                e.stopPropagation();
            });
        }

        Array.prototype.slice.call(popover.querySelectorAll(".track-share-option")).forEach(function (btn) {
            if (btn.dataset.bound) return;
            btn.dataset.bound = "1";
            btn.addEventListener("click", function () {
                var kind = btn.getAttribute("data-share-kind");
                var urlEnc = encodeURIComponent(shareUrl);
                if (kind === "tg") {
                    var tgUrl = "https://t.me/share/url?url=" + urlEnc;
                    window.open(tgUrl, "_blank");
                } else if (kind === "vk") {
                    var vkUrl = "https://vk.com/share.php?url=" + urlEnc;
                    window.open(vkUrl, "_blank");
                } else {
                    // Discord –∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –∫–æ–ø–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(shareUrl);
                    } else {
                        prompt("–°–∫–æ–ø–∏—Ä—É–π —Å—Å—ã–ª–∫—É –Ω–∞ —Ç—Ä–µ–∫:", shareUrl);
                    }
                }
                popover.classList.remove("is-open");
                shareBtn.setAttribute("aria-expanded", "false");
            });
        });
    }
  }

  // Run once on initial load and on Turbo navigations.
  document.addEventListener("turbo:load", initTrackPage);
})();
</script>
{% endblock %}
